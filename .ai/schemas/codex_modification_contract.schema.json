{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Codex Modification Contract",
  "description": "Master contract schema for Codex-driven code modifications with 100% accuracy guarantees",
  "type": "object",
  "required": [
    "contract_version",
    "modification_id",
    "timestamp",
    "specification",
    "baseline",
    "modifications",
    "verification_gates",
    "rollback_strategy"
  ],
  "properties": {
    "contract_version": {
      "type": "string",
      "enum": ["2.0"],
      "description": "Version of the modification contract schema"
    },
    "modification_id": {
      "type": "string",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$",
      "description": "Unique UUID for this modification"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when contract was generated"
    },
    "codex_signature": {
      "type": "string",
      "pattern": "^sha256-[a-fA-F0-9]{64}$",
      "description": "SHA256 hash signature of the modification contract"
    },
    "specification": {
      "type": "object",
      "required": ["objective", "success_criteria", "scope", "constraints"],
      "properties": {
        "objective": {
          "type": "string",
          "minLength": 10,
          "description": "Precise description of what to modify"
        },
        "success_criteria": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 5
          },
          "description": "Measurable outcomes that define success"
        },
        "scope": {
          "type": "object",
          "properties": {
            "file_patterns": {
              "type": "array",
              "items": {"type": "string"}
            },
            "function_names": {
              "type": "array",
              "items": {"type": "string"}
            },
            "class_names": {
              "type": "array",
              "items": {"type": "string"}
            },
            "max_files_affected": {
              "type": "integer",
              "minimum": 1,
              "maximum": 100
            }
          },
          "required": ["file_patterns"],
          "additionalProperties": false
        },
        "constraints": {
          "type": "object",
          "properties": {
            "preserve_interfaces": {
              "type": "boolean",
              "default": true
            },
            "maintain_backwards_compatibility": {
              "type": "boolean",
              "default": true
            },
            "forbidden_modifications": {
              "type": "array",
              "items": {"type": "string"}
            },
            "required_dependencies": {
              "type": "array",
              "items": {"type": "string"}
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "baseline": {
      "type": "object",
      "required": ["repository_hash", "file_checksums", "test_baseline"],
      "properties": {
        "repository_hash": {
          "type": "string",
          "pattern": "^[a-fA-F0-9]{40}$",
          "description": "Git commit hash of baseline state"
        },
        "file_checksums": {
          "type": "object",
          "patternProperties": {
            "^.+$": {
              "type": "string",
              "pattern": "^[a-fA-F0-9]{64}$"
            }
          },
          "description": "SHA256 checksums of all files in scope"
        },
        "test_baseline": {
          "type": "object",
          "required": ["all_tests_pass", "test_command", "coverage_percentage"],
          "properties": {
            "all_tests_pass": {
              "type": "boolean",
              "const": true
            },
            "test_command": {
              "type": "string"
            },
            "coverage_percentage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            }
          },
          "additionalProperties": false
        },
        "dependency_versions": {
          "type": "object",
          "patternProperties": {
            "^.+$": {"type": "string"}
          },
          "description": "Locked dependency versions"
        }
      },
      "additionalProperties": false
    },
    "modifications": {
      "type": "object",
      "required": ["type", "bundle_path", "validation_schema"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["edit_contract_bundle"]
        },
        "bundle_path": {
          "type": "string",
          "pattern": "^\\.ai/bundles/.+\\.json$",
          "description": "Path to the edit contract bundle"
        },
        "validation_schema": {
          "type": "string",
          "pattern": "^\\.ai/schemas/.+\\.json$",
          "description": "Schema to validate the bundle against"
        }
      },
      "additionalProperties": false
    },
    "verification_gates": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["gate_type", "required", "failure_action"],
        "properties": {
          "gate_type": {
            "type": "string",
            "enum": [
              "syntax_check",
              "import_resolution",
              "type_check",
              "test_suite",
              "coverage_check",
              "integration_test",
              "security_scan",
              "dependency_check"
            ]
          },
          "required": {
            "type": "boolean"
          },
          "failure_action": {
            "type": "string",
            "enum": ["abort_modification", "rollback", "continue_with_warning"]
          },
          "configuration": {
            "type": "object",
            "description": "Gate-specific configuration parameters"
          },
          "timeout_seconds": {
            "type": "integer",
            "minimum": 1,
            "maximum": 1800,
            "default": 300
          }
        },
        "additionalProperties": false
      },
      "description": "Ordered list of validation gates that must pass"
    },
    "rollback_strategy": {
      "type": "object",
      "required": ["enabled", "triggers", "restoration_method"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "const": true
        },
        "triggers": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": [
              "syntax_error",
              "test_failure",
              "gate_failure",
              "user_abort",
              "timeout",
              "dependency_conflict"
            ]
          }
        },
        "restoration_method": {
          "type": "string",
          "enum": ["git_reset_hard", "file_restore", "snapshot_restore"]
        },
        "backup_verification": {
          "type": "object",
          "required": ["enabled", "integrity_check"],
          "properties": {
            "enabled": {
              "type": "boolean",
              "const": true
            },
            "integrity_check": {
              "type": "boolean",
              "const": true
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "cost_tracking": {
      "type": "object",
      "properties": {
        "max_tokens": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 200000
        },
        "cost_per_1k_tokens": {
          "type": "number",
          "minimum": 0.001,
          "maximum": 1.0
        },
        "budget_limit_usd": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 100.0
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "properties": {
        "created_by": {"type": "string"},
        "project_name": {"type": "string"},
        "priority": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "estimated_duration_minutes": {
          "type": "integer",
          "minimum": 1,
          "maximum": 120
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
